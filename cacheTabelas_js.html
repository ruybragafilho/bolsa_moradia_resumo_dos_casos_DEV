<script>

  "use strict";

  /**
  *  #######################################################################################
  *  #####                                                                             #####
  *  #####  Módulo:    cacheTabelas_js                                                 #####
  *  #####  Objetivo:  Gerenciar o cache das tabelas de dados carregadas do servidor   #####
  *  #####                                                                             #####
  *  #######################################################################################
  */

  // Cache da tabela Respostas Simples, carregadas via chamada 
  // da função backend obterTabelaCompleta( "RESPOSTAS_SIMPLES" )  
  let cache_TabelaRespostasSimples = [];  

  // Cache da tabela Órgãos Encaminhadores, carregadas via chamada 
  // da função backend obterTabelaCompleta( "ORGAOS_ENCAMINHADORES" )   
  let cache_TabelaOrgaosEncaminhadores = [];    

  // Cache da tabela Situações Benefício, carregadas via chamada 
  // da função backend obterTabelaCompleta( "SITUACOES_BENEFICIO" )  
  let cache_TabelaSituacoesBeneficio = [];

  // Cache da tabela Evoluções, carregadas via chamada da
  // função backend obterTabelaCompleta( "EVOLUCOES" )  
  let cache_TabelaEvolucoes = [];


  // Cache da tabela com os casos, carregadas via chamada 
  // da função backend obterCasos  
  let cache_TabelaCasos = [];



  // Flags que indicam se as tabelas foram carregadas no cache de tabelas
  //    0: ainda não foi carregada
  //    1: já foi carregada
  let flagCache_TabelaRespostasSimples      = 0;
  let flagCache_TabelaOrgaosEncaminhadores  = 0;  
  let flagCache_TabelaSituacoesBeneficio    = 0;  
  let flagCache_TabelaEvolucoes             = 0;  
  let flagCache_TabelaCasos                 = 0;
  


  // Posições das colunas nas tabelas
  const COLUNA_ID    = 0;
  const COLUNA_NOME  = 1;
  const COLUNA_ATIVO = 2;  



  /**
  * Função que pré carrega todas as tabelas da base de dados CODIGOS para o cache de tabelas do frontend
  */  
  function preCarregarTabelasNaCache() {

    carregarTabelaNaCache( "RESPOSTAS_SIMPLES" );    
    carregarTabelaNaCache( "ORGAOS_ENCAMINHADORES" );
    carregarTabelaNaCache( "SITUACOES_BENEFICIO" );
    carregarTabelaNaCache( "EVOLUCOES" );

  } // Fim da função preCarregarTabelasNaCache



  /**
  * Função que retorna true se as tabelas tiverem sido carregadas na cache de tabelas,
  * ou false se ainda não tiverem sido carregadas na cache de tabelas
  */  
  function tabelasCarregadasNaCache() {
    
    if( flagCache_TabelaRespostasSimples      && 
        flagCache_TabelaOrgaosEncaminhadores  &&
        flagCache_TabelaSituacoesBeneficio    &&
        flagCache_TabelaEvolucoes  ) {

      return true;

    } else {

      return false;
    }

  } // Fim da função tabelasCarregadasNaCache  



  /**
  * Função que carrega uma tabela da base de dados CODIGOS para o cache do frontend
  *
  * @param {String} nomeTabela - Nome da tabela da base CODIGO que será carregada   
  */
  function carregarTabelaNaCache( nomeTabela ) {

    google.script.run
                 .withSuccessHandler( tabela => {                     

                    // Atribui a tabela carregada ao cache apropriado
                    switch( nomeTabela ) {
                      
                      case "RESPOSTAS_SIMPLES":     cache_TabelaRespostasSimples     = tabela;
                                                    flagCache_TabelaRespostasSimples = 1;
                                                    break;              

                      case "ORGAOS_ENCAMINHADORES": cache_TabelaOrgaosEncaminhadores     = tabela;
                                                    flagCache_TabelaOrgaosEncaminhadores = 1;  
                                                    break;            

                      case "SITUACOES_BENEFICIO":   cache_TabelaSituacoesBeneficio     = tabela;
                                                    flagCache_TabelaSituacoesBeneficio = 1;  
                                                    break;           

                      case "EVOLUCOES":             cache_TabelaEvolucoes     = tabela;
                                                    flagCache_TabelaEvolucoes = 1;  
                                                    break;            

                      default:                      throw( new Error( "Tabela Inválida" ) ); 

                    }

                 })
                 .withFailureHandler( erro => {

                   // Mostra modal de erro
                   mostrarModalErro( "carregarTabelaNaCache - " + erro.message );

                 })
                 // Chama a função backend para carregar a tabela
                 .obterTabelaCompleta( nomeTabela );                                          

  } // Fim da função carregarTabelaNaCache


</script>