<script>

  "use strict";

  /**
   * Função que processa os parâmetros selecionados, considerando que um mesmo parâmetro
   * pode ser selecionado mais de uma vez, uma em cada categoria associada a ele, essa
   * função deve considerá-lo apenas uma vez
  */
  function processarParametros() {

    // Variáveis para tratar as categorias selecionadas
    const checkBoxIdsCategoriasCaso = document.querySelectorAll('input[name="checkboxCategorias"]:checked');

    // Se nenhum parâmetro tiver sido selecionado, retorna string "" 
    if( checkBoxIdsCategoriasCaso.length < 1 ) return "";

    // Se algum parâmetro tiver sido selecionado, processa os parâmetros
    let arrayIdsCategoriasCaso = Array.from(checkBoxIdsCategoriasCaso).map(chk => chk.value);

    // Variáveis para tratar os parâmetros
    let parametrosSelecionados = [];
    let arrayParametrosSelecionados = [];

    let nameCheckbox;
    let values = [];

    // Lê todos os parâmetros     
    arrayIdsCategoriasCaso.forEach( idCategoria => {

      nameCheckbox = "checkboxParametros_" + idCategoria + "_";
      parametrosSelecionados = document.querySelectorAll(`input[name="${nameCheckbox}"]:checked`);
      values = Array.from(parametrosSelecionados).map(chk => chk.value);
      arrayParametrosSelecionados = arrayParametrosSelecionados.concat( values );

    });

    const conjuntoParametrosSelecionados = new Set(arrayParametrosSelecionados);
    const arraySemDuplicatas = [...conjuntoParametrosSelecionados];

    return arraySemDuplicatas.join(";");

  } // Fim da função processarParametros() 



  /**
   * Função para gerar as abas / guias com os parâmetros das categorias selecionadas
   */
  function mostrarAbasParametros() {
 
    // Reset dos displays de todas as abas
    cache_TabelaCategorias.forEach( categoria => {
      if( categoria[COLUNA_ATIVO] ) {
        document.getElementById( "abasCategorias_" + categoria[COLUNA_ID] ).style.display = "none";
        if( document.getElementById( "abasCategorias_" + categoria[COLUNA_ID] ).classList.contains('active') ) {
          document.getElementById( "abasCategorias_" + categoria[COLUNA_ID] ).classList.remove('active');
        }                
        document.getElementById( "checkboxParametros_" + categoria[COLUNA_ID] + "_" ).style.display = "none";
      }
    });

    // Ids das categorias selecionadas no checkbox de categorias      
    const checkBoxIdsCategoriasCaso = document.querySelectorAll('input[name="checkboxCategorias"]:checked');
    const arrayIdsCategoriasCaso = Array.from(checkBoxIdsCategoriasCaso).map(chk => chk.value);

    // Se algum checkbox de categoria tiver sido selecionado
    if( arrayIdsCategoriasCaso.length ) {

      // Mostra as abas cujas categorias foram selecionadas no checkbox    
      let idAba;
      arrayIdsCategoriasCaso.forEach( item => {
        idAba = "abasCategorias" + "_" + item;
        document.getElementById( idAba ).style.display = "";
      });    

      // Mostra o conteúdo da aba da primeira categoria cujo checkbox está selecionado    
      document.getElementById( "checkboxParametros_" + arrayIdsCategoriasCaso[0] + "_" ).style.display = "block";
      document.getElementById( "abasCategorias_" + arrayIdsCategoriasCaso[0] ).classList.add('active');

    // Se nenhum checkbox tiver sido selecionado, limpa os
    // checkbox de parâmetros - APENAS NO PROCESSO DE INSERÇÃO
    } else {
      
      if( document.getElementById( "tituloPagina" ).value == "INSERÇÃO DE NOVO CASO" ) {
                
        let name;
        let arrayCheckboxParametros = [];

        cache_TabelaCategorias.forEach( categoria => {
          if( categoria[COLUNA_ATIVO] ) {
            name = "checkboxParametros_" + categoria[COLUNA_ID] + "_";
            arrayCheckboxParametros = document.querySelectorAll(`input[name='${name}']`);            
            arrayCheckboxParametros.forEach( checkbox => {
              document.getElementById( checkbox.id ).checked = false;
            });
          }
        });

      } // Fim if Página == "INSERÇÃO DE NOVO CASO"
    } // Fim else   

  } // Fim da função mostrarAbasParametros 


  /**
   * Função para mostrar os checkbox dos parâmetros relacionados à categoria selecionada
   */
  function mostrarConteudoAbaSelecionada() {

    let idAba = event.target.id;
    let idCategoria = idAba.split("_")[1];
    let idConteudoAba = "checkboxParametros_" + idCategoria +"_";

    // Esconde os conteúdos das abas
    cache_TabelaCategorias.forEach( categoria => {
      if( categoria[COLUNA_ATIVO] ) {
        document.getElementById( "checkboxParametros_" + categoria[COLUNA_ID] + "_" ).style.display = "none";
        if( document.getElementById( "abasCategorias_" + categoria[COLUNA_ID] ).classList.contains('active') ) {
          document.getElementById( "abasCategorias_" + categoria[COLUNA_ID] ).classList.remove('active');
        }        
      }
    });

    // Mostra o conteúdo da aba clicada
    document.getElementById( "abasCategorias_" + idCategoria ).classList.add('active');
    document.getElementById( idConteudoAba ).style.display = "block";    

  } // Fim da função mostrarConteudoAbaSelecionada


  /**
   * Função marcar, no frontend, parametros iguais em categorias diferentes.
   * Por exemplo, o parâmetro DETERMINAÇÃO JUDICIAL é comum à todas as categorias.
   * Se ele for marcado ou desmarcado em uma categoria, esse mesmo parâmetro 
   * deve ser alterado nas outras categorias para ficar no mesmo estado
   */
  function marcarParametrosIguais() {

    // Parâmetro clicado no checkbox de parâmetros
    let idCheckboxParametro = event.target.id;    
    let parametro = document.getElementById( idCheckboxParametro );
    let idParametro = parametro.value;

    // Categorias associadas ao parâmetro clicado
    let arrayIdsCategoriasDoParametro = (cache_TabelaParametros[idParametro-1][COLUNA_CATEGORIAS_DO_PARAMETRO]).split(";").filter( id => id != "");    

    // Percorre todos os parâmetros iguais, deixando-os no mesmo estado
    // ( checked ou unchecked ) do parâmetro original
    let idCheckboxParametroIgual;
    arrayIdsCategoriasDoParametro.forEach( idCategoria => {

      if( cache_TabelaCategorias[idCategoria-1][COLUNA_ATIVO] ) {

        idCheckboxParametroIgual = "checkboxParametros_" + idCategoria + "_" + idParametro;
  
        if( parametro.checked ) {
          document.getElementById( idCheckboxParametroIgual ).checked = true;
        } else {
          document.getElementById( idCheckboxParametroIgual ).checked = false;
        }          
      }      

    });

  } // Fim da função marcarParametrosIguais


</script>








  